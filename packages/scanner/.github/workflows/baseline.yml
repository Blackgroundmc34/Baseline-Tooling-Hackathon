name: Baseline Compatibility
on:
  pull_request: { branches: [ "**" ] }

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm' }

      - name: Install deps (root)
        run: npm ci || npm i

      - name: Install deps (scanner)
        working-directory: packages/scanner
        run: npm ci || npm i

      - name: Run scan + report + gate
        working-directory: packages/scanner
        env:
          MAX_NONE: '3'   # <-- your current policy
          MAX_LOW:  '10'
        run: npm run ci

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: baseline-compat-report
          path: |
            packages/scanner/report.json
            packages/scanner/report.html
            packages/scanner/report.csv

      - name: Comment summary on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const rpt = JSON.parse(fs.readFileSync('packages/scanner/report.json','utf8'));
            const s = rpt.summary.baseline;
            const msg = `### Baseline Report\n**Widely:** ${s.high} · **Newly:** ${s.low} · **Not in:** ${s.none}\n\nArtifacts: report.html / report.csv (see Actions)`;
            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body: msg
            });
